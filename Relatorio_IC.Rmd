---
title: "Aplicação de métodos de simulação de dados sintéticos"
author: "Fernanda Buzza Alves Barros"
date: "__ de ________ de ____"
output:
  pdf_document: default
  word_document: default
  html_document:
    df_print: paged
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE)
```

```{r, message=FALSE, echo=FALSE}
library(mice)
library(VIM)
library(CASdatasets)
library(tidyverse)
library(gridExtra)
## library(pryr)
library(car)
library(knitr)
```

```{r, message=FALSE, echo=FALSE, results=FALSE}
source("01-organizando_os_dados.R")
```

# INTRODUÇÃO

Problemas de dados faltantes em pesquisa são recorrentes em bancos de dados. Para a solução desses problemas existem vários métodos que podem ser utilizados. Entretanto, todos os métodos possuem uma questão principal: como inferir os valores não observados?

Para a resposta dessa pergunta, temos que o ideal seria ter os dados, porém na falta deles temos que utilizar o método que melhor se ajusta a distribuição dos dados.

Nessa pesquisa utilizaremos o método proposto por Rubin (1987), Van Buuren e Groothuis-Oudshoorn (2011), que é conhecido como Imputação Múltipla.

# METODOLOGIA

A Imputação Múltipla consiste em gerar valores (m vezes) para os dados faltantes, ela cria uma matriz com todas as M imputações. Para gerar essas imputações existem alguns métodos, como por exemplo *Predictive Mean Matching (pmm)* e *Unconditional Mean Imputation (mean)*, que serão os métodos utilizados nesse estudo.

## Predictive Mean Matching (pmm)

## Unconditional Mean Imputation (mean)

# RESULTADOS

## Banco de dados

Para realizar a imputação dos dados utilizamos o banco de dados *US Term Life insurance* do pacote *CASdatasets* disponível no software R. As imputações e os resultados foram obtidos utilizando esse mesmo software estatístico. O banco de dados possui 18 variáveis com 500 observações, como pode ser visto abaixo.

```{r, echo=FALSE, message=FALSE}
str(ustermlife)
```

Porém selecionamos as seguintes variáveis para realizar a pesquisa:
Gênero (gênero do entrevistado);
Idade (idade do entrevistado);
Estado Civil (estado civil do entrevistado);
Escolaridade (número de anos de escolaridade do entrevistado);
Etnia (etnia do entrevistado);
Renda (renda anual da família do entrevistado).

Primeiras observações do banco de dados original:
```{r, echo=FALSE, message=FALSE}
head(dados_originais)
```

## Análise Descritiva

```{r, echo=FALSE, message=FALSE}
source(file="02-analise_descritiva.R", encoding="UTF-8")
```

Após a escolha das variáveis para esse estudo, iremos realizar uma análise descritiva de cada uma delas, e assim avaliar as relações existentes entre a variável resposta e as covariáveis do banco de dados. Ao final realizaremos um dos principais objetivos dessa pesquisa, que é verificar os possíveis questionamentos sobre a Renda a partir das outras variáveis.

Primeiramente analisaremos as variáveis individualmente, com interesse em suas distribuições e comportamentos. Pelos dados observamos que as variáveis contínuas são: Renda, Idade e Escolaridade, e as variáveis discretas são: Gênero, Estado Civil e Etnia.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p100-graf.pdf")
```

Para as variáveis discretas temos que o banco de dados possui uma quantidade maior de entrevistados do sexo masculino (413 entrevistados) do que do sexo feminino (87 entrevistadas); para o estado civil temos uma concentração maior de respostas para os entrevistados Casados (333 entrevistados) e a menor quantidade de entrevistados pertence ao estado civil de Morando Juntos (31 entrevistados), sendo que o estado civil Outros possui 136 entrevistados; por fim para a etnia temos uma maior quantidade de entrevistados que possuem etnia Branco (365 entrevistados), sendo que as outras etnias possuem valores menores de entrevistados no banco de dados: Hispânico (40 entrevistados), Negro (70 entrevistados) e Outros (25 entrevistados).

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p101-graf.pdf")
```

```{r, echo=FALSE, message=FALSE}
source(file="02-analise_descritiva.R", encoding="UTF-8")
max_idade = max(dados_originais$Age)
min_idade = min(dados_originais$Age)
media_idade = mean(dados_originais$Age)
mediana_idade = median(dados_originais$Age)
quantil1_idade = quantile(dados_originais$Age, 0.25)
quantil3_idade = quantile(dados_originais$Age, 0.75)
```

Para as variáveis contínuas temos que a variável Idade está bastante distribuída entre os 20 anos e 70 anos, após 70 anos vemos poucos entrevistados no banco de dados, sendo também que a idade máxima é `r max_idade` anos e a idade mínima é `r min_idade` anos. A média é `r media_idade` anos e a mediana `r mediana_idade` anos. O primeiro quantil é de `r quantil1_idade` anos, representando a idade que deixa 25% das observações abaixo e 75% acima dessa idade. E o terceiro quantil é de `r quantil3_idade` anos, representando a idade que possui 75% das observações abaixo dela e 25% das observações acima dela.

A distribuição da variável Escolaridade possui maior concentração de entrevistados após 10 anos de escolaridade.

```{r, echo=FALSE, message=FALSE}
source(file="02-analise_descritiva.R", encoding="UTF-8")
max_renda = max(dados_originais$Income)
min_renda = min(dados_originais$Income)
media_renda = mean(dados_originais$Income)
mediana_renda = median(dados_originais$Income)
## quantil1_renda = quantile(dados_originais$Income, 0.25)
## quantil3_renda = quantile(dados_originais$Income, 0.75)
```

E para a variável Renda temos que a renda mínima anual é `r min_renda` dólares e a renda máxima anual é `r max_renda` dólares. A mediana e a média são 54000 dólares e 321021 doláres, respectivamente. O primeiro quantil é de 28000 dólares, representando o valor de renda anual que deixa 25% das observações abaixo dela e 75% acima deela. E o terceiro quantil é de 106000 dólares, representando a renda anual que possui 75% das observações abaixo dela e 25% das observações acima dela. Aplicamos o logarítimo para melhor visualização da distribuição da renda anual através do histograma e percebemos uma aparência com a distribuição normal.

Além da análise da variável Escolaridade em anos, foi realizada também a análise dos anos de escolaridade divididos pelos tipos de ensino existentes, que são: 2-10 anos de escolaridade é o Ensino Fundamental, 11-14 anos de escolaridade é o Ensino Médio e de 15-17 anos de escolaridade é o Ensino Superior, assim obtemos:

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p102-graf.pdf")
```

Avaliando os tipos de ensino percebemos uma maior concentração de entrevistados que possuem o ensino médio e o ensino superior, sendo que quase a metade dos entrevistados possuem ensino superior, esse valor corresponde a 248 entrevistados.

Analisamos também a relação entre a variável resposta (Renda) e as covariáveis presentes no banco de dados escolhido. Assim obtivemos os seguintes resultados:

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p103-graf.pdf")
```

Para as variáveis discretas temos os boxplots da Log(Renda) com cada uma das variáveis separadamente. Para o gênero observamos um valor de renda maior para o sexo masculino, comparando com o sexo feminino; já a variável Estado Civil os entrevistados casados possuem uma renda maior, sendo que a mediana da renda dos que moram juntos com o parceiro(a) e outros estão bastante próximas, porém são inferiores aos valores de renda dos entrevistados casados. Na comparação entre a Log(Renda) e a Etnia percebemos uma amplitude da renda maior para as etnias Branco e Outros, entretanto, como foi observado anteriormente, essas etnias correspondem a 73% e 5%, respectivamente, do total do banco de dados.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p12-graf.pdf")
```

Para a relação entre as variáveis Log(Renda) e a Idade temos o gráfico de dispersão acima, nele percebemos uma pequena inclinação no ajuste da curva quando ocorre o aumento das idades dos entrevistados, o que indica um possível ganho de renda anual maior para os entrevistados a medida que aumenta a idade.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p27-graf.pdf")
```

Analisando as variáveis Anos de Escolaridade e a Idade, percebemos uma inclinação quando aumenta os anos de escolaridade e as idades dos entrevistados, ou seja, os entrevistados possuem maior anos de escolaridade à medida que aumentam as idade, o que condiz com a realidade dos ensinos visto anteiormente. Embora quantidades de anos de escolaridade maior possuem grande concentração de pessoas em diversas idades, para os anos de escolaridade entre 2-10 percebemos a presença de variabilidade.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p21-graf.pdf")
```

Avaliando a relação entre as variáveis Log(Renda) e a recodificação da variável Anos de Escolaridade, variável separada em tipos de ensino para melhor visualização da relação existente, temos que o tipo de ensino influencia na renda dos entrevistados. Assim observamos valores de renda maiores para o Ensino Superior, que possui de 15-17 anos de escolaridade.

Após a apresentação das variáveis individualmente e em pares com a variável de interesse renda anual, realizamos a análise das variáveis em trios, como por exemplo a Log(Renda), Idade e o Gênero. As análises da relação dessas variáveis permitem fazer suposições sobre os modelos a serem estudados e verificar a influência de cada covariável na variável resposta.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p17-graf.pdf")
```

Analisando a relação entre as variáveis Log(Renda), Idade e Gênero percebemos o quanto a idade e o gênero influenciam nos valores da renda anual. O gráfico possui o ajuste das retas e mostra claramente o que foi discutido anteriormente, sobre os valores de renda anual para o sexo masculino serem maiores que o do sexo feminino; podemos perceber também uma inclinação na reta, à medida que aumenta a idade, para o sexo masculino, entretanto para as mulheres essa inclinação é muito pequena ou inexistente.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p18-graf.pdf")
```

Para a análise entre as variáveis Log(Renda), Idade e Estado Civil, podemos observar que os entrevistados casados possuem uma quantidade maior de renda e através da inclinação da reta podemos concluir que a renda aumenta através da idade, já para os entrevistados que estão morando junto e os outros tipos de estado civil as retas e a inclinação estão quase juntas, sendo que possuem pequenas diferenças em algumas idades; o gráfico acima também mostra como está a distribuição por estado civil dos entrevistados.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p28-graf.pdf")
```

Analisando a relação entre as variáveis Log(Renda), Idade e a Etnia, vemos que as retas pertencentes as etnias Branco, Negro e Outros partem quase do mesmo valor de renda, entretanto, ao longo das idades, possuem comportamentos diferentes para a inclinação da reta, sendo que para a etnia Negro a renda decresce a medida que aumenta a idade. Observamos maior renda para a etnia Outros, os Hispânicos, que começam a reta abaixo das outras etnias, intercepta a etnia Negro entre as idades 40-50 anos. Pelo gráfico da distribuição percebemos que a etnia Hispânico estão concentrados em torno do Log(Renda) igual a 10, e que a etnia Negro possue valores de renda bastante dispersos a medida que aumenta a idade.  

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p22-graf.pdf")
```

Para a análise entre as variáveis Log(Renda), Idade e os tipos de Ensino, confirmamos a conlusão anterior sobre o Ensino Superior possuir renda maior que os outros tipos de ensino. Sendo que nas idades mais jovens a renda para o Ensino Fundamental e o Ensino Médio estão muito próximas quando analisamos a inclinação da reta, entretanto a partir dos 30 anos as retas desses dois tipos de ensino começam a se distanciar; assim há um aumento de renda para o Ensino Médio enquanto o Ensino Fundamental apresenta declínio.

## Imputação

O banco de dados escolhido para aplicação da imputação não possui dados faltantes, portanto para avaliar os casos de imputação foi necessário gerar os dados faltantes. Os casos de imputação múltipla existentes são: perda completamente aleatória, perda aleatória e perda não aleatória. Sendo que na perda completamente aleatória o motivo pelo qual os dados estão ausentes não está relacionado às variáveis do estudo; já na perda aleatória a razão para um valor estar ausente está relacionada às outras variáveis observadas, mas não está relacionada à variável em que há valores ausentes; e por fim na perda não aleatória o motivo pelo qual os dados estão ausentes está diretamente relacionado aos valores não observados da variável de interesse.

Para realização da imputação utilizamos o pacote *Multivariate Imputation With Chained Equations (MICE)*. A função que realiza a imputação chama-se mice, e nesse estudo realizamos a imputação 5 vezes (m=5) tanto para o método da *PMM* e da *Mean* para comparar os resultados.

### Perda Completamente Aleatória

Como dito anteriormente o banco de dados utilizado nesse estudo não possui dados ausentes. Para tanto o mecanismo de Perda Completamente Aleatória consiste em que o motivo pelo qual os dados estão ausentes não está relacionado as variáveis do estudo. Sendo assim para esse mecanismo utilizamos uma distribuição bernoulli com probabilidade de sucesso de 0,20 para gerar os dados ausentes na variável Renda, e fixamos uma semente ao gerar os números aleatórios.

Primeiras observações do banco de dados com dados faltantes na variável Renda:
```{r, echo=FALSE, message=FALSE}
head(dados_MCAR)
```

Pelos box-plots abaixo podemos verificar os valores da Renda com os dados ausentes e as imputações geradas.
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p41-graf.pdf")
```

Nos box-plots acima percebemos que as 5 imputações geradas seguem de modo semelhante a distribuição do banco com os valores ausentes.

Como possuímos o banco de dados original realizamos a análise dos valores da renda no banco original com os valores da renda das imputações, e assim obtemos a seguinte distribuição:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
gg34.graf
```

Pelo gráfico de dispersão acima, temos que os valores orignais e os valores imputados estão bastante próximos, o que pode ser verificado também pelos box-plots abaixo, que analisa o banco de dados original e as imputações:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p42-graf.pdf")
```

Para realizar a adequação do modelo temos o gráfico QQ-plot abaixo:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p43-graf.pdf")
```

Pelo QQ-plot podemos chegar a adequação do modelo dos dados com as observações faltantes com as imputações realizadas. Nele vemos que os valores estão bastante concentrados indicando que os valores imputados são adequados.

Como dito anteriormente para gerar o mecanismo de perda completamente aleatória criamos os valores ausente na variável renda no banco de dados original, das 500 observações presentes no banco de dados o mecanismo gerou 96 observações ausentes. Portanto analisamos somente essas observações originais ausentes com os valores que foram imputados para elas. Assim temos abaixo os box-plots dessas 96 observações:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p44-graf.pdf")
```

### Perda Aleatória

O mecanismo de perda aleatória consiste em que a razão para um valor estar ausente está relacionada às outras variáveis do observadas, mas não está relacionada à variável em que há valores ausentes. Para gerar os dados ausentes desse mecanismo avaliamos a perda da variável Renda conjuntamente com as variáveis Gênero e Tipo de Ensino.

#### Gênero

Para gerar os dados ausentes na renda, pelo caso de perda aleatória conjuntamente com o gênero, utilizamos uma distribuição bernoulli com probabilidade de sucesso de 0,10 para o sexo feminino e 0,30 para o sexo masculino, e fixamos uma semente ao gerar os números aleatórios.

Os box-plots abaixo indicam como estão a distribuição dos valores da renda para o banco de dados com valores ausentes na renda e as imputações:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p46-graf.pdf")
```

Pelos box-plots podemos verificar que há pequenos desvios entre eles, porém as imputações possuem bastante proximidade com o banco de dados com valores faltantes.

Como possuímos o banco de dados original realizamos a análise dos valores da renda no banco original com os valores da renda das imputações, e assim obtemos a seguinte distribuição:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
gg50.graf
```

Pelo gráfico de dispersão acima percebemos melhor a distribuição verificada no gráfico dos box-plots anterior, novamente observamos indícios de pequenos desvios entre o banco de dados original e o banco de dados imputação. Nas imputações 2, 3 e 4 percebemos imputações de valores da log(renda) próximos de 5 sendo que no banco de dados original não encontramos tais valores ausentes ao redor do log(renda) igual a 5.

Para verificar esses pequenos desvios nas imputações com o banco original temos os box-plot abaixo:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p47-graf.pdf")
```

Por esses box-plots percebemos ainda o indício de pequenos desvios nas imputações comparada com o banco original. Portanto abaixo temos o QQ-plot no intuito de checar a adequação do ajuste:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p48-graf.pdf")
```

Pelo QQ-plot acima percebemos para valores menores que o log(renda) de 10 e maiores que o log(renda) de 14, um deslocamento maior entre as imputações e a reta de adequação do modelo entre os quantis originais e o quantis imputados da log(renda).

Como dito anteriormente para gerar o mecanismo de perda completamente aleatória criamos os valores ausente na variável renda no banco de dados original, das 500 observações presentes no banco de dados o mecanismo gerou 96 observações ausentes. Portanto analisamos somente essas observações originais ausentes com os valores que foram imputados para elas. Assim temos abaixo os box-plots dessas 96 observações:
```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p49-graf.pdf")
```

#### Tipo de Ensino

Para gerar os dados ausentes na variável renda, pelo caso de perda aleatória em conjunto com a variável tipo de ensino, utilizamos uma distribuição binomial com probabilidade de sucesso de 0,05 para o ensino fundamental, 0,20 para o ensino médio e 0,40 para o ensino superior, e fixamos uma semente ao gerar os números aleatórios.

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
##include_graphics("p50-graf.pdf")
```

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p51-graf.pdf")
```

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p52-graf.pdf")
```

```{r, echo=FALSE, message=FALSE, fig.align='center', out.width = "100%", purl=FALSE}
include_graphics("p53-graf.pdf")
```

### Perda Não Aleatória



# CONCLUSÃO



# REFERÊNCIAS BIBLIOGRÁFICAS

Little, R.J.A. and Rubin, D.B. (1987). Statistical Analysis with Missing Data. John Wiley & Sons, New York.

Van Buuren, S., Groothuis-Oudshoorn, K. (2011). mice: Multivariate Imputation by Chained Equations in R. Journal of Statistical Software, 45(3), 1-67. [linked phrase](http://www.jstatsoft.org/v45/i03/)

Morris TP, White IR, Royston P (2015). Tuning multiple imputation by predictive mean matching and local residual draws. BMC Med Res Methodol. ;14:75.

Frees, E.W. (2011). Regression Modeling with Actuarial and Financial Applications, Cambridge University Press.
